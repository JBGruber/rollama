---
title: "text-embedding"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{text-embedding}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  fig.path = "figures/",
  comment = "#>"
)
options(tidyverse.quiet = TRUE)
options(rollama_verbose = FALSE)
library(rollama)
library(ggplot2)
library(bench)
models <- c("tinyllama:1.1b", "llama2:latest", "llama3:latest")
server <- NULL
check_model_installed(models)
```

This is the short test to be able to compare different machines running (r)ollama:

```{r benchmarks_short, warning=FALSE}
benchmarks_short <- lapply(models, function(m) {
  bench::mark(query("Why is the sky blue?",
                    model = m,
                    screen = FALSE,
                    server = server,
                    model_params = list(seed = 42, temperature = 0)),
              memory = FALSE,
              min_iterations = 10L)
}) |>
  purrr::list_rbind()
benchmarks_short$expression <- paste0(models, "_short")
tab1 <- summary(benchmarks_short, relative = FALSE)
cli::cat_rule("absolute")
print(tab1)
tab2 <- summary(benchmarks_short, relative = TRUE)
cli::cat_rule("relative")
print(tab2)
ggplot2::autoplot(benchmarks_short)
```

This is the longer test:

```{r benchmarks_long, warning=FALSE}
benchmarks_long <- lapply(models, function(m) {
  bench::mark(query(paste("Summarize this:",
                          paste(readLines("annotation.Rmd"),
                                collapse = "\n")),
                    model = m,
                    screen = FALSE,
                    server = server,
                    model_params = list(seed = 42, temperature = 0)),
              memory = FALSE,
              min_iterations = 10L)
}) |>
  purrr::list_rbind()
benchmarks_long$expression <- paste0(models, "_long")
tab1 <- summary(benchmarks_long, relative = FALSE)
cli::cat_rule("absolute")
print(tab1)
tab2 <- summary(benchmarks_long, relative = TRUE)
cli::cat_rule("relative")
print(tab2)
ggplot2::autoplot(benchmarks_long)
```

You can compare this to previously measured results:

```{r}
data("bench_results", package = "rollama")
bench_results <- bench_results |> 
  tibble::add_case(
    machine = "laptop",
    specs = "CPU: AMD Ryzen 7 PRO 6850U (16) @ 4.768GHz | GPU: - | Memory: 32GB DDR5",
    model = c(benchmarks_short$expression, benchmarks_long$expression),
    benchmark = c(rep("short", 3L), rep("long", 3L)),
    min = c(benchmarks_short$min, benchmarks_long$min),
    median = c(benchmarks_short$median, benchmarks_long$median),
    time = c(benchmarks_short$time, benchmarks_long$time)
  )
```

```{r}
library(ggplot)
ggplot(bench_results, aes(x = median, y = model, colour = machine)) +
  geom_point() +
  scale_x_continuous(labels = \(l) paste0(l, "s")) +
  labs(x = NULL, y = NULL, title = "Time to run benchmark in seconds") +
  theme_minimal()
```


```{r}
#| eval: false
#| echo: false
usethis::use_data(bench_results, overwrite = TRUE)
```

