<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>annotation • rollama</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="annotation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rollama</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/annotation.html">annotation</a></li>
    <li><a class="dropdown-item" href="../articles/hf-gguf.html">Hugging Face Models</a></li>
    <li><a class="dropdown-item" href="../articles/image-annotation.html">image-annotation</a></li>
    <li><a class="dropdown-item" href="../articles/text-embedding.html">text-embedding</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JBGruber/rollama/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>annotation</h1>
                        <h4 data-toc-skip class="author">Maximilian
Weber and Johannes B. Gruber</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JBGruber/rollama/blob/main/vignettes/annotation.Rmd" class="external-link"><code>vignettes/annotation.Rmd</code></a></small>
      <div class="d-none name"><code>annotation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>After you installed Ollama on your machine and downloaded the package
rollama you can load the package and pull a model. The default model
(<code>llama3.1</code>), is a good all-round chat model. For annotation,
however, the instruction tuned llama models are often better suited, as
they follow instructions more diligently and are less likely to trail
off into a conversation. By changing the option
<code>rollama_model</code>, we can change which model is used by default
in the current session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jbgruber.github.io/rollama/">rollama</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>rollama_model <span class="op">=</span> <span class="st">"llama3.2:3b-instruct-q8_0"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pull_model.html">pull_model</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ model llama3.2:3b-instruct-q8_0 pulled succesfully</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prompting-strategies">Prompting Strategies<a class="anchor" aria-label="anchor" href="#prompting-strategies"></a>
</h2>
<p>If you want to annotate textual data, you can use various prompting
strategies. For an overview of common approaches, you can read a paper
by <a href="https://arxiv.org/abs/2401.00284" class="external-link">Weber and Reichardt
(2023)</a>. These strategies primarily differ in whether or how many
examples are given (Zero-shot, One-shot, or Few-shot) and whether
reasoning is involved (Chain-of-Thought).</p>
<p>When writing a prompt we can give the model content for the system
part, user part and assistant part. The system message typically
includes instructions or context that guides the interaction, setting
the stage for how the user and the assistant should interact. For an
annotation task we could write: “You assign texts into categories.
Answer with just the correct category.” The table below summarizes
different prompting strategies for annotating textual data. Each
strategy varies in the number of examples given and the incorporation of
reasoning.</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Prompting Strategy</th>
<th>Example Structure</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Zero-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="even">
<td>One-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="odd">
<td>Few-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>. . . more examples</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="even">
<td>Chain-of-Thought</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Text to classify) + reasoning question"},</code><br><code>{"role": "assistant", "content": "Reasoning"},</code><br><code>{"role": "user", "content": "Classification question"}</code>
</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="zero-shot">Zero-shot<a class="anchor" aria-label="anchor" href="#zero-shot"></a>
</h3>
<p>In this approach, no prior examples are given. The structure includes
a system prompt providing instructions and a user prompt with the text
to classify and the classification question (in this example we only
provide the categories).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; negative</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="one-shot">One-shot<a class="anchor" aria-label="anchor" href="#one-shot"></a>
</h3>
<p>This involves giving a single example before the actual task. The
structure includes a system prompt, followed by a user prompt with an
example text and classification question, the assistant’s example
classification, and then another user prompt with the new text to
classify.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Negative"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Positive</span></span></code></pre></div>
<p>A nice side effect of the one-shot strategy (and all
n&gt;0-strategies) is that you can tune the format the model uses in its
replies. For example, if you want to have an output that easy to parse,
you could change the assistant message to
<code>"{'Category':'Negative'}"</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"{'Category':'Negative'}"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">answer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; {'Category':'Positive'}</span></span></code></pre></div>
<p>This is a valid JSON return and can be parsed into a list with, e.g.,
<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON()</a></code>. Using this logic, we could request a
more informative output:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Provide the following information: category, confidence, and the word that is most important for your coding decision."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"{'Category':'Negative','Confidence':'100%','Important':'terrible'}"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">answer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; {'Category':'Positive','Confidence':'100%','Important':'great'}</span></span></code></pre></div>
<p>By using <code>pluck(answer, "message", "content")</code>, you can
directly extract the result and don’t need to copy it from screen.</p>
</div>
<div class="section level3">
<h3 id="few-shot">Few-shot<a class="anchor" aria-label="anchor" href="#few-shot"></a>
</h3>
<p>This strategy includes multiple examples (more than one). The
structure is similar to one-shot but with several iterations of user and
assistant messages providing examples before the final text to
classify.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Negative"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Positive"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: I once came here with my wife\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Neutral"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: I once ate pizza\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Neutral</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="chain-of-thought">Chain-of-Thought<a class="anchor" aria-label="anchor" href="#chain-of-thought"></a>
</h3>
<p>This approach involves at least one reasoning step. The structure
here starts with the system prompt, then a user prompt with a text to
classify and a reasoning question.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_thought</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. "</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\nWhat sentiment (positive, neutral, or negative) would you assign? Provide some thoughts."</span></span>
<span><span class="op">)</span></span>
<span><span class="va">output_thought</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_thought</span>, output <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; I would assign a **negative** sentiment to this text.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Here's why:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * The word "terrible" is a strong adjective that implies a strongly</span></span>
<span><span class="co">#&gt; unfavorable opinion. It suggests that the speaker has had a very poor</span></span>
<span><span class="co">#&gt; experience with the pizza.</span></span>
<span><span class="co">#&gt; * The tone of the sentence is direct and critical, implying that the</span></span>
<span><span class="co">#&gt; speaker was not just mildly dissatisfied but actively disliked the pizza.</span></span>
<span><span class="co">#&gt; * There's no nuance or mixed sentiment in this text; it's a</span></span>
<span><span class="co">#&gt; straightforward expression of dislike.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall, the language and tone used suggest that the speaker had a very</span></span>
<span><span class="co">#&gt; negative experience with the pizza.</span></span></code></pre></div>
<p>In the next step we can use the assistant’s reasoning and a user
prompt with the classification question.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. "</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\nWhat sentiment (positive, neutral, or negative) would you assign? Provide some thoughts."</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="va">output_thought</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"Now answer with just the correct category (positive, neutral, or negative)"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">resps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; Negative</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-make_query-helper-function">The <code>make_query</code> helper function<a class="anchor" aria-label="anchor" href="#the-make_query-helper-function"></a>
</h3>
<p>The <code>make_query</code> function is designed to facilitate the
creation of a structured query for text classification, so that you do
not need to build the tibble yourself and remember the specific
structure.</p>
<p>Components:</p>
<ul>
<li>
<strong>text</strong> to Classify: The new text(s) to be
annotated.</li>
<li>
<strong>prompt</strong>: Classification question with the categories
to be annotated.</li>
<li>
<strong>template</strong>: Defines the structure for user messages.
Defines the structure for user messages. The template can include
placeholders like {text}, {prefix}, and {suffix} to dynamically format
input.</li>
<li>
<strong>system</strong>: System Prompt: Provides context or
instructions for the classification task (optional).</li>
<li>
<strong>prefix</strong>: A string to prepend to user queries
(optional).</li>
<li>
<strong>suffix</strong>: A string to append to user queries
(optional).</li>
<li>
<strong>examples</strong>: Prior examples consisting of user
messages and assistant responses (for one-shot and few-shot
learning)(optional).</li>
</ul>
</div>
<div class="section level3">
<h3 id="example-usage">Example usage<a class="anchor" aria-label="anchor" href="#example-usage"></a>
</h3>
<div class="section level4">
<h4 id="zero-shot-example">Zero-shot example<a class="anchor" aria-label="anchor" href="#zero-shot-example"></a>
</h4>
<p>In this example, the function is used without any examples.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call the make_query function</span></span>
<span><span class="va">q_zs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_query.html">make_query</a></span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="st">"{text}\n{prompt}"</span>,</span>
<span>  text <span class="op">=</span> <span class="st">"the pizza tastes terrible"</span>,</span>
<span>  prompt <span class="op">=</span> <span class="st">"Categories: positive, neutral, negative"</span>,</span>
<span>  system <span class="op">=</span> <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the query</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">q_zs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   role   content                                                           </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;glue&gt;                                                            </span></span>
<span><span class="co">#&gt; 1 system You assign texts into categories. Answer with just the correct ca…</span></span>
<span><span class="co">#&gt; 2 user   the pizza tastes terrible</span></span>
<span><span class="co">#&gt; Categories: positive, neutral, negative</span></span>
<span><span class="co"># Run the query</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_zs</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; negative</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="one-shot-example">One-shot example<a class="anchor" aria-label="anchor" href="#one-shot-example"></a>
</h4>
<p>Here, one prior example is provided to aid the classification:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examples_os</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">text</span>, <span class="op">~</span><span class="va">answer</span>,</span>
<span>  <span class="st">"the pizza tastes terrible"</span>, <span class="st">"negative"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">q_os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_query.html">make_query</a></span><span class="op">(</span></span>
<span>  text <span class="op">=</span> <span class="st">"the service is great"</span>,</span>
<span>  template <span class="op">=</span> <span class="st">"{text}\n{prompt}"</span>,</span>
<span>  prompt <span class="op">=</span> <span class="st">"Categories: positive, neutral, negative"</span>,</span>
<span>  system <span class="op">=</span> <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">q_os</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   role   content                                                           </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;glue&gt;                                                            </span></span>
<span><span class="co">#&gt; 1 system You assign texts into categories. Answer with just the correct ca…</span></span>
<span><span class="co">#&gt; 2 user   the service is great</span></span>
<span><span class="co">#&gt; Categories: positive, neutral, negative</span></span>
<span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_os</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; positive</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="few-shot-example-with-multiple-examples">Few-shot example with multiple examples<a class="anchor" aria-label="anchor" href="#few-shot-example-with-multiple-examples"></a>
</h4>
<p>This scenario uses multiple examples to enrich the context for the
new classification:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examples_fs</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">text</span>, <span class="op">~</span><span class="va">answer</span>,</span>
<span>  <span class="st">"the pizza tastes terrible"</span>, <span class="st">"negative"</span>,</span>
<span>  <span class="st">"the service is great"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"I once came here with my wife"</span>, <span class="st">"neutral"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">q_fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_query.html">make_query</a></span><span class="op">(</span></span>
<span>  text <span class="op">=</span> <span class="st">"I once ate pizza"</span>,</span>
<span>  prompt <span class="op">=</span> <span class="st">"Categories: positive, neutral, negative"</span>,</span>
<span>  template <span class="op">=</span> <span class="st">"{text}\n{prompt}"</span>,</span>
<span>  system <span class="op">=</span> <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  examples <span class="op">=</span> <span class="va">examples_fs</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_fs</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer from llama3.2:3b-instruct-q8_0 ──────────────────────────────────</span></span>
<span><span class="co">#&gt; neutral</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="batch-annotation">Batch annotation<a class="anchor" aria-label="anchor" href="#batch-annotation"></a>
</h2>
<p>In practice, you probably never want to annotate just one text,
except maybe for testing. Instead you normally have a collections of
texts, which is why <code>make_query</code> takes a vector for the
<code>text</code> argument. In this section, we highlight how this is
useful with an example batch of texts.</p>
</div>
<div class="section level2">
<h2 id="example-using-a-dataframe">Example using a dataframe<a class="anchor" aria-label="anchor" href="#example-using-a-dataframe"></a>
</h2>
<p>This example demonstrates how to perform sentiment analysis on a set
of movie reviews. The process involves creating a dataframe of reviews,
processing each review to classify its sentiment, and appending the
results as a new column in the dataframe.</p>
<p>We create a dataframe named <code>movie_reviews</code> with two
columns:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an example dataframe with 5 movie reviews</span></span>
<span><span class="va">movie_reviews</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  review_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>  review <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A stunning visual spectacle with a gripping storyline."</span>,</span>
<span>             <span class="st">"The plot was predictable, but the acting was superb."</span>,</span>
<span>             <span class="st">"An overrated film with underwhelming performances."</span>,</span>
<span>             <span class="st">"A beautiful tale of love and adventure, beautifully shot."</span>,</span>
<span>             <span class="st">"The movie lacked depth, but the special effects were incredible."</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Print the initial dataframe</span></span>
<span><span class="va">movie_reviews</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 2</span></span>
<span><span class="co">#&gt;   review_id review                                                         </span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;chr&gt;                                                          </span></span>
<span><span class="co">#&gt; 1         1 A stunning visual spectacle with a gripping storyline.         </span></span>
<span><span class="co">#&gt; 2         2 The plot was predictable, but the acting was superb.           </span></span>
<span><span class="co">#&gt; 3         3 An overrated film with underwhelming performances.             </span></span>
<span><span class="co">#&gt; 4         4 A beautiful tale of love and adventure, beautifully shot.      </span></span>
<span><span class="co">#&gt; 5         5 The movie lacked depth, but the special effects were incredibl…</span></span></code></pre></div>
<p>We can use <code>make_query</code> again to define a query for each
of these reviews. What we want to do is to perform a sentiment analysis,
guided by a system message and a classification question.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process each review using make_query</span></span>
<span><span class="va">queries</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_query.html">make_query</a></span><span class="op">(</span></span>
<span>  text <span class="op">=</span> <span class="va">movie_reviews</span><span class="op">$</span><span class="va">review</span>,</span>
<span>  prompt <span class="op">=</span> <span class="st">"Categories: positive, neutral, negative"</span>,</span>
<span>  template <span class="op">=</span> <span class="st">"{prefix}{text}\n{prompt}"</span>,</span>
<span>  system <span class="op">=</span> <span class="st">"Classify the sentiment of the movie review. Answer with just the correct category."</span>,</span>
<span>  prefix <span class="op">=</span> <span class="st">"Text to classify: "</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This produces a list of data.frames that have the same query format
we are now familiar with. All of them have the same prompt, system
message and prefix, but each has a different text that came from the
movie reviews data.frame we created above. The <code>query</code>
function accepts lists of queries, so we can get the annotations simply
using:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process and annotate the movie reviews</span></span>
<span><span class="va">movie_reviews</span><span class="op">$</span><span class="va">annotation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">queries</span>, screen <span class="op">=</span> <span class="cn">FALSE</span>, output <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the annotated dataframe</span></span>
<span><span class="va">movie_reviews</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;   review_id review                                               annotation</span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;chr&gt;                                                &lt;chr&gt;     </span></span>
<span><span class="co">#&gt; 1         1 A stunning visual spectacle with a gripping storyli… Positive  </span></span>
<span><span class="co">#&gt; 2         2 The plot was predictable, but the acting was superb. positive  </span></span>
<span><span class="co">#&gt; 3         3 An overrated film with underwhelming performances.   Negative  </span></span>
<span><span class="co">#&gt; 4         4 A beautiful tale of love and adventure, beautifully… Positive  </span></span>
<span><span class="co">#&gt; 5         5 The movie lacked depth, but the special effects wer… Neutral</span></span></code></pre></div>
<p>We can also use this approach in a ‘tidy’ coding style:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">movie_reviews_annotated</span> <span class="op">&lt;-</span> <span class="va">movie_reviews</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    queries <span class="op">=</span> <span class="fu"><a href="../reference/make_query.html">make_query</a></span><span class="op">(</span></span>
<span>      text <span class="op">=</span> <span class="va">review</span>,</span>
<span>      prompt <span class="op">=</span> <span class="st">"Categories: positive, neutral, negative"</span>,</span>
<span>      template <span class="op">=</span> <span class="st">"{prefix}{text}\n{prompt}"</span>,</span>
<span>      system <span class="op">=</span> <span class="st">"Classify the sentiment of the movie review. Answer with just the correct category."</span>,</span>
<span>      prefix <span class="op">=</span> <span class="st">"Text to classify: "</span></span>
<span>    <span class="op">)</span>,</span>
<span>    sentiment <span class="op">=</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">queries</span>, screen <span class="op">=</span> <span class="cn">FALSE</span>, output <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This takes a little longer than classic supervised machine learning
or even classification with transformer models. However, the advantage
is that instructions can be provided using plain English, the models
need very few examples to perform surprisingly well, and the best
models, like <code>llama3.2</code>, can often deal with more complex
categories than other approaches.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johannes B. Gruber, Maximilian Weber.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
