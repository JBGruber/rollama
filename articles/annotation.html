<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rollama">
<title>annotation • rollama</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="annotation">
<meta property="og:description" content="rollama">
<meta property="og:image" content="https://jbgruber.github.io/rollama/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rollama</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/annotation.html">annotation</a>
    <a class="dropdown-item" href="../articles/image-annotation.html">image-annotation</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/JBGruber/rollama/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>annotation</h1>
                        <h4 data-toc-skip class="author">Maximilian
Weber and Johannes B. Gruber</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JBGruber/rollama/blob/HEAD/vignettes/annotation.Rmd" class="external-link"><code>vignettes/annotation.Rmd</code></a></small>
      <div class="d-none name"><code>annotation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>After you installed Ollama on your machine and downloaded the package
rollama you can load the package and pull the default model
(<code>llama2</code>) by calling:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jbgruber.github.io/rollama/">rollama</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pull_model.html">pull_model</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ model llama2 pulled succesfully</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prompting-strategies">Prompting Strategies<a class="anchor" aria-label="anchor" href="#prompting-strategies"></a>
</h2>
<p>If you want to annotate textual data, you can use various prompting
strategies. For an overview of common approaches, you can read a paper
by <a href="https://arxiv.org/abs/2401.00284" class="external-link">Weber and Reichardt
(2023)</a>. These strategies primarily differ in whether or how many
examples are given (Zero-shot, One-shot, or Few-shot) and whether
reasoning is involved (Chain-of-Thought).</p>
<p>When writing a prompt we can give the model content for the system
part, user part and assistant part. The system message typically
includes instructions or context that guides the interaction, setting
the stage for how the user and the assistant should interact. For an
annotation task we could write: “You assign texts into categories.
Answer with just the correct category.” The table below summarizes
different prompting strategies for annotating textual data. Each
strategy varies in the number of examples given and the incorporation of
reasoning.</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Prompting Strategy</th>
<th>Example Structure</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Zero-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="even">
<td>One-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="odd">
<td>Few-shot</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>{"role": "user", "content": "(Example text) + classification question"},</code><br><code>{"role": "assistant", "content": "Example classification"},</code><br><code>. . . more examples</code><br><code>{"role": "user", "content": "(Text to classify) + classification question"}</code>
</td>
</tr>
<tr class="even">
<td>Chain-of-Thought</td>
<td>
<code>{"role": "system", "content": "Text of System Prompt"},</code><br><code>{"role": "user", "content": "(Text to classify) + reasoning question"},</code><br><code>{"role": "assistant", "content": "Reasoning"},</code><br><code>{"role": "user", "content": "Classification question"}</code>
</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="zero-shot">Zero-shot<a class="anchor" aria-label="anchor" href="#zero-shot"></a>
</h3>
<p>In this approach, no prior examples are given. The structure includes
a system prompt providing instructions and a user prompt with the text
to classify and the classification question (in this example we only
provide the categories).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Negative</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="one-shot">One-shot<a class="anchor" aria-label="anchor" href="#one-shot"></a>
</h3>
<p>This involves giving a single example before the actual task. The
structure includes a system prompt, followed by a user prompt with an
example text and classification question, the assistant’s example
classification, and then another user prompt with the new text to
classify.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Negative"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Positive</span></span></code></pre></div>
<p>A nice side effect of the one-shot strategy (and all
n&gt;0-strategies) is that you can tune the format the model uses in its
replies. For example, if you want to have an output that is easy to
parse, you could change the assistant message to
<code>"{'Category':'Negative','Confidence':'100%','Important':'terrible'}"</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"{'Category':'Negative','Confidence':'100%','Important':'terrible'}"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">answer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span>, model_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>num_gpu <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; {'Category':'Positive','Confidence':'100%','Important':'great'}</span></span></code></pre></div>
<p>This is a valid JSON return and can be parsed into a list with, e.g.,
<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON()</a></code>. By using
<code>pluck(answer, "message", "content")</code>, you can directly
extract the result and don’t need to copy it from screen.</p>
</div>
<div class="section level3">
<h3 id="few-shot">Few-shot<a class="anchor" aria-label="anchor" href="#few-shot"></a>
</h3>
<p>This strategy includes multiple examples (more than one). The
structure is similar to one-shot but with several iterations of user and
assistant messages providing examples before the final text to
classify.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. Answer with just the correct category."</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the pizza tastes terrible\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Negative"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: the service is great\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Positive"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: I once came here with my wife\ncategories: positive, neutral, negative"</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="st">"Category: Neutral"</span>,</span>
<span>  <span class="st">"user"</span>, <span class="st">"text: I once ate pizza\ncategories: positive, neutral, negative"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Neutral</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="chain-of-thought">Chain-of-Thought<a class="anchor" aria-label="anchor" href="#chain-of-thought"></a>
</h3>
<p>This approach involves at least one reasoning step. The structure
here starts with the system prompt, then a user prompt with a text to
classify and a reasoning question.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_thought</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. "</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\nWhat sentiment (positive, neutral, or negative) would you assign? Provide some thoughts."</span></span>
<span><span class="op">)</span></span>
<span><span class="va">output_thought</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_thought</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Based on the text "the pizza tastes terrible," I would assign a sentiment of negative. Here's why:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * The use of the word "tastes" implies that the speaker has a strong opinion about the taste of the pizza, which is typically associated with negative</span></span>
<span><span class="co">#&gt; emotions.</span></span>
<span><span class="co">#&gt; * The phrase "terrible" is a strong adjective that conveys a sense of disappointment or displeasure.</span></span>
<span><span class="co">#&gt; * The sentiment is further reinforced by the fact that the speaker used the word "tastes," which implies a personal evaluation or judgment about the pizza's</span></span>
<span><span class="co">#&gt; taste, rather than a neutral description.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall, based on the language and structure of the sentence, it seems clear that the speaker has a negative sentiment towards the pizza.</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="va">output_thought</span>, <span class="st">"message"</span>, <span class="st">"content"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nBased on the text \"the pizza tastes terrible,\" I would assign a sentiment of negative. Here's why:\n\n* The use of the word \"tastes\" implies that the speaker has a strong opinion about the taste of the pizza, which is typically associated with negative emotions.\n* The phrase \"terrible\" is a strong adjective that conveys a sense of disappointment or displeasure.\n* The sentiment is further reinforced by the fact that the speaker used the word \"tastes,\" which implies a personal evaluation or judgment about the pizza's taste, rather than a neutral description.\n\nOverall, based on the language and structure of the sentence, it seems clear that the speaker has a negative sentiment towards the pizza."</span></span></code></pre></div>
<p>In the next step we can use the assistant’s reasoning and a user
prompt with the classification question.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>  <span class="st">"system"</span>, <span class="st">"You assign texts into categories. "</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"text: the pizza tastes terrible\nWhat sentiment (positive, neutral, or negative) would you assign? Provide some thoughts."</span>,</span>
<span>  <span class="st">"assistant"</span>, <span class="va">output_thought</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">content</span>,</span>
<span>  <span class="st">"user"</span>,   <span class="st">"Now answer with just the correct category (positive, neutral, or negative)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Negative</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="batch-annotation">Batch annotation<a class="anchor" aria-label="anchor" href="#batch-annotation"></a>
</h2>
<p>In practice, you probably never want to annotate just one text. In
this section, we show you how you can wrap <code><a href="../reference/query.html">rollama::query()</a></code>
into another function to ask the model to annotate a batch of texts. We
might add this function to the package in the future, but at the moment,
we want to keep it simple.</p>
<div class="section level3">
<h3 id="function-to-create-a-query">Function to create a query<a class="anchor" aria-label="anchor" href="#function-to-create-a-query"></a>
</h3>
<p>The <code>create_query</code> function is designed to facilitate the
creation of a structured query for text classification.</p>
<p>Components:</p>
<ul>
<li>
<strong>System Message</strong>: Provides context or instructions
for the classification task.</li>
<li>
<strong>Examples</strong>: Prior examples consisting of user
messages and assistant responses (for one-shot and few-shot
learning).</li>
<li>
<strong>Text to Classify</strong>: The new text to be
categorized.</li>
<li>
<strong>Classification Question</strong>: Lists the possible
categories for classification.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">systemmsg</span>, <span class="va">examples</span>, <span class="va">texttoclassify</span>, <span class="va">classification_question</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Start with the system message</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">role</span>,    <span class="op">~</span><span class="va">content</span>,</span>
<span>    <span class="st">"system"</span>, <span class="va">systemmsg</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add examples (if any), appending the classification question to the user messages</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">example</span> <span class="kw">in</span> <span class="va">examples</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">usermsg_with_question</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">example</span><span class="op">$</span><span class="va">usermsg</span>, <span class="st">"\n"</span>, <span class="va">classification_question</span><span class="op">)</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html" class="external-link">add_row</a></span><span class="op">(</span><span class="va">q</span>, role <span class="op">=</span> <span class="st">"user"</span>, content <span class="op">=</span> <span class="va">usermsg_with_question</span><span class="op">)</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html" class="external-link">add_row</a></span><span class="op">(</span><span class="va">q</span>, role <span class="op">=</span> <span class="st">"assistant"</span>, content <span class="op">=</span> <span class="va">example</span><span class="op">$</span><span class="va">assistantmsg</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Add the current text to classify along with the classification question</span></span>
<span>  <span class="va">usermsg_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"text:"</span>, <span class="va">texttoclassify</span>, <span class="st">"\n"</span>, <span class="va">classification_question</span><span class="op">)</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html" class="external-link">add_row</a></span><span class="op">(</span><span class="va">q</span>, role <span class="op">=</span> <span class="st">"user"</span>, content <span class="op">=</span> <span class="va">usermsg_final</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-usage">Example usage<a class="anchor" aria-label="anchor" href="#example-usage"></a>
</h3>
<div class="section level4">
<h4 id="zero-shot-example">Zero-shot example<a class="anchor" aria-label="anchor" href="#zero-shot-example"></a>
</h4>
<p>In this example, the function is used without any examples.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">systemmsg</span> <span class="op">&lt;-</span> <span class="st">"You assign texts into categories. Answer with just the correct category."</span></span>
<span><span class="va">q_zs</span> <span class="op">&lt;-</span> <span class="fu">create_query</span><span class="op">(</span><span class="va">systemmsg</span>, examples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"the pizza tastes terrible"</span>, <span class="st">"Categories: positive, neutral, negative"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_zs</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Category: Negative</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="one-shot-example-with-one-example">One-shot example with one example<a class="anchor" aria-label="anchor" href="#one-shot-example-with-one-example"></a>
</h4>
<p>Here, one prior example is provided to aid the classification:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examples_os</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    usermsg <span class="op">=</span> <span class="st">"text: the pizza tastes terrible"</span>,</span>
<span>    assistantmsg <span class="op">=</span> <span class="st">"Category: Negative"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q_os</span> <span class="op">&lt;-</span> <span class="fu">create_query</span><span class="op">(</span><span class="va">systemmsg</span>, <span class="va">examples_os</span>, <span class="st">"the service is great"</span>, <span class="st">"Categories: positive, neutral, negative"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_os</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Positive</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="few-shot-example-with-multiple-examples">Few-shot example with multiple examples<a class="anchor" aria-label="anchor" href="#few-shot-example-with-multiple-examples"></a>
</h4>
<p>This scenario uses multiple examples to enrich the context for the
new classification:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examples_fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    usermsg <span class="op">=</span> <span class="st">"text: the pizza tastes terrible"</span>,</span>
<span>    assistantmsg <span class="op">=</span> <span class="st">"Category: Negative"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    usermsg <span class="op">=</span> <span class="st">"text: the service is great"</span>,</span>
<span>    assistantmsg <span class="op">=</span> <span class="st">"Category: Positive"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    usermsg <span class="op">=</span> <span class="st">"text: I once came here with my wife"</span>,</span>
<span>    assistantmsg <span class="op">=</span> <span class="st">"Category: Neutral"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q_fs</span> <span class="op">&lt;-</span> <span class="fu">create_query</span><span class="op">(</span><span class="va">systemmsg</span>, <span class="va">examples_fs</span>, <span class="st">"I once ate pizza"</span>, <span class="st">"Categories: positive, neutral, negative"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q_fs</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Answer ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Category: Positive</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="another-example-using-a-dataframe">Another example using a dataframe<a class="anchor" aria-label="anchor" href="#another-example-using-a-dataframe"></a>
</h2>
<p>This example demonstrates how to perform sentiment analysis on a set
of movie reviews. The process involves creating a dataframe of reviews,
processing each review to classify its sentiment, and appending the
results as a new column in the dataframe.</p>
<p>We create a dataframe named <code>movie_reviews</code> with two
columns:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an example dataframe with 5 movie reviews</span></span>
<span><span class="va">movie_reviews</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  review_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>  review <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A stunning visual spectacle with a gripping storyline."</span>,</span>
<span>             <span class="st">"The plot was predictable, but the acting was superb."</span>,</span>
<span>             <span class="st">"An overrated film with underwhelming performances."</span>,</span>
<span>             <span class="st">"A beautiful tale of love and adventure, beautifully shot."</span>,</span>
<span>             <span class="st">"The movie lacked depth, but the special effects were incredible."</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Print the initial dataframe</span></span>
<span><span class="va">movie_reviews</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 2</span></span>
<span><span class="co">#&gt;   review_id review                                                </span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;chr&gt;                                                 </span></span>
<span><span class="co">#&gt; 1         1 A stunning visual spectacle with a gripping storyline.</span></span>
<span><span class="co">#&gt; 2         2 The plot was predictable, but the acting was superb.  </span></span>
<span><span class="co">#&gt; 3         3 An overrated film with underwhelming performances.    </span></span>
<span><span class="co">#&gt; 4         4 A beautiful tale of love and adventure, beautifully s…</span></span>
<span><span class="co">#&gt; 5         5 The movie lacked depth, but the special effects were …</span></span></code></pre></div>
<p>We define a system message and a classification question to guide the
sentiment analysis:</p>
<p>The function <code>process_reviews</code></p>
<ul>
<li>Iterates through each review.</li>
<li>Constructs a query using <code>create_query</code>.</li>
<li>Obtains sentiment classification (by <code>query(q)</code>
function).</li>
<li>Stores the result in the <code>annotations</code> vector.</li>
<li>Appends <code>annotations</code> as a new column in the
dataframe.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">systemmsg</span> <span class="op">&lt;-</span> <span class="st">"Classify the sentiment of the movie review. Answer with just the correct category."</span></span>
<span><span class="va">classification_question</span> <span class="op">&lt;-</span> <span class="st">"Categories: positive, neutral, negative"</span></span>
<span></span>
<span><span class="co"># Function to process each review and append the result to a new column</span></span>
<span><span class="va">process_reviews</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">reviews</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">annotations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"character"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">reviews</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">reviews</span><span class="op">$</span><span class="va">review</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu">create_query</span><span class="op">(</span><span class="va">systemmsg</span>, examples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">reviews</span><span class="op">$</span><span class="va">review</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">classification_question</span><span class="op">)</span></span>
<span>    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query.html">query</a></span><span class="op">(</span><span class="va">q</span>, screen <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">annotations</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="va">output</span>, <span class="st">"message"</span>, <span class="st">"content"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">reviews</span><span class="op">$</span><span class="va">annotation</span> <span class="op">&lt;-</span> <span class="va">annotations</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">reviews</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Process and annotate the movie reviews</span></span>
<span><span class="va">annotated_reviews</span> <span class="op">&lt;-</span> <span class="fu">process_reviews</span><span class="op">(</span><span class="va">movie_reviews</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the annotated dataframe</span></span>
<span><span class="va">annotated_reviews</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;   review_id review                                      annotation</span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;chr&gt;                                       &lt;chr&gt;     </span></span>
<span><span class="co">#&gt; 1         1 A stunning visual spectacle with a grippin… "\nPositi…</span></span>
<span><span class="co">#&gt; 2         2 The plot was predictable, but the acting w… "Positive"</span></span>
<span><span class="co">#&gt; 3         3 An overrated film with underwhelming perfo… "Negative"</span></span>
<span><span class="co">#&gt; 4         4 A beautiful tale of love and adventure, be… "Positive"</span></span>
<span><span class="co">#&gt; 5         5 The movie lacked depth, but the special ef… "Negative"</span></span></code></pre></div>
<p>This takes a little longer than classic supervised machine learning
or even classification with transformer models. However, the advantage
is that instructions can be provided using plain English, the models
need very few examples to perform surprisingly well, and the best
models, like <code>mixtral</code>, can often deal more complex
categories than other approaches.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Johannes B. Gruber, Maximilian Weber.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
