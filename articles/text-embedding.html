<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rollama">
<title>text-embedding • rollama</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="text-embedding">
<meta property="og:description" content="rollama">
<meta property="og:image" content="https://jbgruber.github.io/rollama/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rollama</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/annotation.html">annotation</a>
    <a class="dropdown-item" href="../articles/image-annotation.html">image-annotation</a>
    <a class="dropdown-item" href="../articles/text-embedding.html">text-embedding</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/JBGruber/rollama/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>text-embedding</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JBGruber/rollama/blob/HEAD/vignettes/text-embedding.Rmd" class="external-link"><code>vignettes/text-embedding.Rmd</code></a></small>
      <div class="d-none name"><code>text-embedding.Rmd</code></div>
    </div>

    
    
<p>Ollama, and hence <code>rollama</code>, can be used for text
embedding. In short, text embedding uses the knowledge of the meaning of
words inferred from the context that is saved in a large language model
through its training to turn text into meaningful vectors of numbers.
This technique is a powerful preprocessing step for supervised machine
learning and often increases the performance of a classification model
substantially. Compared to using <code>rollama</code> directly for
classification, the advantage is that converting text into embeddings
and then using these embeddings for classification is usually faster and
more resource efficient – especially if you re-use embeddings for
multiple tasks.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jbgruber.github.io/rollama/">rollama</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/AFAgarap/ecommerce-reviews-analysis/master/Womens%20Clothing%20E-Commerce%20Reviews.csv"</span>,</span>
<span>                       show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">reviews_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 23,486</span></span>
<span><span class="co">#&gt; Columns: 11</span></span>
<span><span class="co">#&gt; $ ...1                      [3m[38;5;246m&lt;dbl&gt;[39m[23m 0, 1, 2, 3, 4, 5, 6,…</span></span>
<span><span class="co">#&gt; $ `Clothing ID`             [3m[38;5;246m&lt;dbl&gt;[39m[23m 767, 1080, 1077, 104…</span></span>
<span><span class="co">#&gt; $ Age                       [3m[38;5;246m&lt;dbl&gt;[39m[23m 33, 34, 60, 50, 47, …</span></span>
<span><span class="co">#&gt; $ Title                     [3m[38;5;246m&lt;chr&gt;[39m[23m NA, NA, "Some major …</span></span>
<span><span class="co">#&gt; $ `Review Text`             [3m[38;5;246m&lt;chr&gt;[39m[23m "Absolutely wonderfu…</span></span>
<span><span class="co">#&gt; $ Rating                    [3m[38;5;246m&lt;dbl&gt;[39m[23m 4, 5, 3, 5, 5, 2, 5,…</span></span>
<span><span class="co">#&gt; $ `Recommended IND`         [3m[38;5;246m&lt;dbl&gt;[39m[23m 1, 1, 0, 1, 1, 0, 1,…</span></span>
<span><span class="co">#&gt; $ `Positive Feedback Count` [3m[38;5;246m&lt;dbl&gt;[39m[23m 0, 4, 0, 0, 6, 4, 1,…</span></span>
<span><span class="co">#&gt; $ `Division Name`           [3m[38;5;246m&lt;chr&gt;[39m[23m "Initmates", "Genera…</span></span>
<span><span class="co">#&gt; $ `Department Name`         [3m[38;5;246m&lt;chr&gt;[39m[23m "Intimate", "Dresses…</span></span>
<span><span class="co">#&gt; $ `Class Name`              [3m[38;5;246m&lt;chr&gt;[39m[23m "Intimates", "Dresse…</span></span></code></pre></div>
<p>Now this is a rather big dataset, and I don’t want to stress my GPU
too much, so I only select the first 500 reviews for embedding. I also
process the data slightly by combining the title and review text into a
single column and turning the rating into a binary variable:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews</span> <span class="op">&lt;-</span> <span class="va">reviews_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>id <span class="op">=</span> <span class="va">...1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>rating <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Rating</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5"</span>, <span class="st">"&lt;5"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>full_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Title</span><span class="op">)</span>, <span class="st">""</span>, <span class="va">Title</span><span class="op">)</span>, <span class="va">`Review Text`</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To turn one or multiple texts into embeddings, you can simply use
<code>embed_text</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/embed_text.html">embed_text</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">reviews</span><span class="op">$</span><span class="va">full_text</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ embedded 3 texts [4s] </span></span>
<span><span class="co">#&gt; # A tibble: 3 × 4,096</span></span>
<span><span class="co">#&gt;   dim_1  dim_2 dim_3  dim_4 dim_5  dim_6  dim_7  dim_8 dim_9 dim_10</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  1.85 -1.71   1.47  0.478 -1.75  0.771  3.01   0.961 1.65   0.569</span></span>
<span><span class="co">#&gt; 2  1.14 -3.61   2.10 -0.385 -4.11 -3.09   0.990 -1.06  2.55   1.84 </span></span>
<span><span class="co">#&gt; 3 -3.35  0.172 -3.49 -0.569 -3.14  1.25  -0.102  1.15  0.575 -2.33 </span></span>
<span><span class="co">#&gt; # ℹ 4,086 more variables: dim_11 &lt;dbl&gt;, dim_12 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_13 &lt;dbl&gt;, dim_14 &lt;dbl&gt;, dim_15 &lt;dbl&gt;, dim_16 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_17 &lt;dbl&gt;, dim_18 &lt;dbl&gt;, dim_19 &lt;dbl&gt;, dim_20 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_21 &lt;dbl&gt;, dim_22 &lt;dbl&gt;, dim_23 &lt;dbl&gt;, dim_24 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_25 &lt;dbl&gt;, dim_26 &lt;dbl&gt;, dim_27 &lt;dbl&gt;, dim_28 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_29 &lt;dbl&gt;, dim_30 &lt;dbl&gt;, dim_31 &lt;dbl&gt;, dim_32 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_33 &lt;dbl&gt;, dim_34 &lt;dbl&gt;, dim_35 &lt;dbl&gt;, dim_36 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>To use this on the sample of reviews, I put the embeddings into a new
column, before unnesting the resulting data.frame. The reason behind
this is that I want to make sure the embeddings belong to the correct
review ID. I also use a different model this time: <a href="https://ollama.com/library/nomic-embed-text" class="external-link"><code>nomic-embed-text</code></a>.
While models like <code>llama2</code> are extremely powerful at handling
conversations and natural language requests, they are also
computationally intensive, and hence relatively slow. As of version
0.1.26, Ollama support using dedicated embedding models, which can
perform the task a lot faster and with fewer resources. Download the
model with <code>pull_model("nomic-embed-text")</code> then we can
run:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_embeddings</span> <span class="op">&lt;-</span> <span class="va">reviews</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>embeddings <span class="op">=</span> <span class="fu"><a href="../reference/embed_text.html">embed_text</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">full_text</span>, model <span class="op">=</span> <span class="st">"nomic-embed-text"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">rating</span>, <span class="va">embeddings</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">embeddings</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ embedded 500 texts [7m 19.4s]       </span></span></code></pre></div>
<p>The resulting data.frame contains the ID and rating along the 768
embedding dimensions:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_embeddings</span></span>
<span><span class="co">#&gt; # A tibble: 500 × 770</span></span>
<span><span class="co">#&gt;       id rating   dim_1 dim_2 dim_3  dim_4   dim_5 dim_6</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;fct&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     0 &lt;5      1.23   1.66  -3.35 -0.161 -0.0393 0.113</span></span>
<span><span class="co">#&gt;  2     1 5       0.881  0.696 -2.34 -0.798 -1.56   1.53 </span></span>
<span><span class="co">#&gt;  3     2 &lt;5      0.507  1.03  -2.10 -0.398 -0.822  1.78 </span></span>
<span><span class="co">#&gt;  4     3 5      -0.253  0.866 -3.12 -0.225 -0.562  1.14 </span></span>
<span><span class="co">#&gt;  5     4 5       0.308  1.05  -2.80 -1.20  -0.466  0.477</span></span>
<span><span class="co">#&gt;  6     5 &lt;5      0.860  0.894 -2.29 -0.642 -1.38   2.24 </span></span>
<span><span class="co">#&gt;  7     6 5       0.573  0.257 -2.26 -0.681 -0.592  0.461</span></span>
<span><span class="co">#&gt;  8     7 &lt;5      0.199  0.628 -2.33 -0.374 -1.51   0.174</span></span>
<span><span class="co">#&gt;  9     8 5      -0.124  1.19  -3.17 -0.267 -0.705  0.683</span></span>
<span><span class="co">#&gt; 10     9 5      -0.0137 1.05  -2.54 -0.214 -1.48   0.721</span></span>
<span><span class="co">#&gt; # ℹ 490 more rows</span></span>
<span><span class="co">#&gt; # ℹ 762 more variables: dim_7 &lt;dbl&gt;, dim_8 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_9 &lt;dbl&gt;, dim_10 &lt;dbl&gt;, dim_11 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_12 &lt;dbl&gt;, dim_13 &lt;dbl&gt;, dim_14 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_15 &lt;dbl&gt;, dim_16 &lt;dbl&gt;, dim_17 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_18 &lt;dbl&gt;, dim_19 &lt;dbl&gt;, dim_20 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_21 &lt;dbl&gt;, dim_22 &lt;dbl&gt;, dim_23 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>As said above, these embeddings are often used in supervised machine
learning. I use part of <a href="https://emilhvitfeldt.com/post/textrecipes-series-pretrained-word-embeddings/" class="external-link">a
blog post by Emil Hvitfeldt</a> show how this can be done using the data
we embedded above in the powerful <code>tidymodels</code> collection of
packages:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co"># split data into training an test set (for validation)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">reviews_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">reviews_embeddings</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reviews_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">reviews_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up the model we want to use</span></span>
<span><span class="va">lasso_spec</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we specify that we want to do some hyperparameter tuning and bootstrapping</span></span>
<span><span class="va">param_grid</span> <span class="op">&lt;-</span> <span class="fu">grid_regular</span><span class="op">(</span><span class="fu">penalty</span><span class="op">(</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">reviews_boot</span> <span class="op">&lt;-</span> <span class="fu">bootstraps</span><span class="op">(</span><span class="va">reviews_train</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and we define the model. Here we use the embeddings to predict the rating</span></span>
<span><span class="va">rec_spec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">rating</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="fu">select</span><span class="op">(</span><span class="va">reviews_train</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bringing this together in a workflow</span></span>
<span><span class="va">wf_fh</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">rec_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lasso_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we do the tuning</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">lasso_grid</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">wf_fh</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">reviews_boot</span>,</span>
<span>  grid <span class="op">=</span> <span class="va">param_grid</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select the best model</span></span>
<span><span class="va">wf_fh_final</span> <span class="op">&lt;-</span> <span class="va">wf_fh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">lasso_grid</span>, <span class="st">"roc_auc"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and train a new model + predict the classes for the test set</span></span>
<span><span class="va">final_res</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">wf_fh_final</span>, <span class="va">reviews_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we extract these predictions</span></span>
<span><span class="va">final_pred</span> <span class="op">&lt;-</span> <span class="va">final_res</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and evaluate them with a few standard metrics</span></span>
<span><span class="va">my_metrics</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span>, <span class="va">precision</span>, <span class="va">recall</span>, <span class="va">f_meas</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">my_metrics</span><span class="op">(</span><span class="va">final_pred</span>, truth <span class="op">=</span> <span class="va">rating</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;   .metric   .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy  binary         0.752</span></span>
<span><span class="co">#&gt; 2 precision binary         0.694</span></span>
<span><span class="co">#&gt; 3 recall    binary         0.847</span></span>
<span><span class="co">#&gt; 4 f_meas    binary         0.763</span></span>
<span></span>
<span><span class="co"># and the ROC curve</span></span>
<span><span class="va">final_pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">rating</span>, <span class="va">.pred_5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figures/smldemo-1.png" alt="ROC curve"><div class="figcaption">ROC curve</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Johannes B. Gruber, Maximilian Weber.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
