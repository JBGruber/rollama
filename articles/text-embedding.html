<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>text-embedding • rollama</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="text-embedding">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rollama</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/annotation.html">annotation</a></li>
    <li><a class="dropdown-item" href="../articles/image-annotation.html">image-annotation</a></li>
    <li><a class="dropdown-item" href="../articles/text-embedding.html">text-embedding</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JBGruber/rollama/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>text-embedding</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JBGruber/rollama/blob/main/vignettes/text-embedding.Rmd" class="external-link"><code>vignettes/text-embedding.Rmd</code></a></small>
      <div class="d-none name"><code>text-embedding.Rmd</code></div>
    </div>

    
    
<p>Ollama, and hence <code>rollama</code>, can be used for text
embedding. In short, text embedding uses the knowledge of the meaning of
words inferred from the context that is saved in a large language model
through its training to turn text into meaningful vectors of numbers.
This technique is a powerful preprocessing step for supervised machine
learning and often increases the performance of a classification model
substantially. Compared to using <code>rollama</code> directly for
classification, the advantage is that converting text into embeddings
and then using these embeddings for classification is usually faster and
more resource efficient – especially if you re-use embeddings for
multiple tasks.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jbgruber.github.io/rollama/">rollama</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/AFAgarap/ecommerce-reviews-analysis/master/Womens%20Clothing%20E-Commerce%20Reviews.csv"</span>,</span>
<span>                       show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">reviews_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 23,486</span></span>
<span><span class="co">#&gt; Columns: 11</span></span>
<span><span class="co">#&gt; $ ...1                      0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,…</span></span>
<span><span class="co">#&gt; $ `Clothing ID`             767, 1080, 1077, 1049, 847, 1080, 858, 858, 1077, 1077, 1077,…</span></span>
<span><span class="co">#&gt; $ Age                       33, 34, 60, 50, 47, 49, 39, 39, 24, 34, 53, 39, 53, 44, 50, 4…</span></span>
<span><span class="co">#&gt; $ Title                     NA, NA, "Some major design flaws", "My favorite buy!", "Flatt…</span></span>
<span><span class="co">#&gt; $ `Review Text`             "Absolutely wonderful - silky and sexy and comfortable", "Lov…</span></span>
<span><span class="co">#&gt; $ Rating                    4, 5, 3, 5, 5, 2, 5, 4, 5, 5, 3, 5, 5, 5, 3, 4, 3, 5, 5, 5, 4…</span></span>
<span><span class="co">#&gt; $ `Recommended IND`         1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span><span class="co">#&gt; $ `Positive Feedback Count` 0, 4, 0, 0, 6, 4, 1, 4, 0, 0, 14, 2, 2, 0, 1, 3, 2, 0, 0, 0, …</span></span>
<span><span class="co">#&gt; $ `Division Name`           "Initmates", "General", "General", "General Petite", "General…</span></span>
<span><span class="co">#&gt; $ `Department Name`         "Intimate", "Dresses", "Dresses", "Bottoms", "Tops", "Dresses…</span></span>
<span><span class="co">#&gt; $ `Class Name`              "Intimates", "Dresses", "Dresses", "Pants", "Blouses", "Dress…</span></span></code></pre></div>
<p>Now this is a rather big dataset, and I don’t want to stress my GPU
too much, so I only select the first 500 reviews for embedding. I also
process the data slightly by combining the title and review text into a
single column and turning the rating into a binary variable:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews</span> <span class="op">&lt;-</span> <span class="va">reviews_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>id <span class="op">=</span> <span class="va">...1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>rating <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Rating</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5"</span>, <span class="st">"&lt;5"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>full_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Title</span><span class="op">)</span>, <span class="st">""</span>, <span class="va">Title</span><span class="op">)</span>, <span class="va">`Review Text`</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To turn one or multiple texts into embeddings, you can simply use
<code>embed_text</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/embed_text.html">embed_text</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">reviews</span><span class="op">$</span><span class="va">full_text</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 4,096</span></span>
<span><span class="co">#&gt;   dim_1   dim_2  dim_3  dim_4  dim_5  dim_6  dim_7  dim_8 dim_9  dim_10 dim_11  dim_12 dim_13</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  1.32  2.04    1.45  -0.342 0.0834 -0.718 -4.20   3.22  -5.04 -0.466    2.27  0.0522  2.31 </span></span>
<span><span class="co">#&gt; 2  1.72 -1.29   -0.428 -1.16  0.651  -2.70  -2.60  -0.615 -8.36  0.768    1.98 -2.34    0.286</span></span>
<span><span class="co">#&gt; 3 -3.17  0.0776  0.925 -4.02  2.64   -1.40  -0.113  2.18  -5.58  0.0541   3.48  0.434   1.66 </span></span>
<span><span class="co">#&gt; # ℹ 4,083 more variables: dim_14 &lt;dbl&gt;, dim_15 &lt;dbl&gt;, dim_16 &lt;dbl&gt;, dim_17 &lt;dbl&gt;, dim_18 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_19 &lt;dbl&gt;, dim_20 &lt;dbl&gt;, dim_21 &lt;dbl&gt;, dim_22 &lt;dbl&gt;, dim_23 &lt;dbl&gt;, dim_24 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_25 &lt;dbl&gt;, dim_26 &lt;dbl&gt;, dim_27 &lt;dbl&gt;, dim_28 &lt;dbl&gt;, dim_29 &lt;dbl&gt;, dim_30 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_31 &lt;dbl&gt;, dim_32 &lt;dbl&gt;, dim_33 &lt;dbl&gt;, dim_34 &lt;dbl&gt;, dim_35 &lt;dbl&gt;, dim_36 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_37 &lt;dbl&gt;, dim_38 &lt;dbl&gt;, dim_39 &lt;dbl&gt;, dim_40 &lt;dbl&gt;, dim_41 &lt;dbl&gt;, dim_42 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_43 &lt;dbl&gt;, dim_44 &lt;dbl&gt;, dim_45 &lt;dbl&gt;, dim_46 &lt;dbl&gt;, dim_47 &lt;dbl&gt;, dim_48 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_49 &lt;dbl&gt;, dim_50 &lt;dbl&gt;, dim_51 &lt;dbl&gt;, dim_52 &lt;dbl&gt;, dim_53 &lt;dbl&gt;, dim_54 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>To use this on the sample of reviews, I put the embeddings into a new
column, before unnesting the resulting data.frame. The reason behind
this is that I want to make sure the embeddings belong to the correct
review ID. I also use a different model this time: <a href="https://ollama.com/library/nomic-embed-text" class="external-link"><code>nomic-embed-text</code></a>.
While models like <code>llama3.1</code> are extremely powerful at
handling conversations and natural language requests, they are also
computationally intensive, and hence relatively slow. As of version
0.1.26, Ollama support using dedicated embedding models, which can
perform the task a lot faster and with fewer resources. Download the
model with <code>pull_model("nomic-embed-text")</code> then we can
run:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_embeddings</span> <span class="op">&lt;-</span> <span class="va">reviews</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>embeddings <span class="op">=</span> <span class="fu"><a href="../reference/embed_text.html">embed_text</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">full_text</span>, model <span class="op">=</span> <span class="st">"nomic-embed-text"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">rating</span>, <span class="va">embeddings</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">embeddings</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ embedded 500 texts [25s]           </span></span></code></pre></div>
<p>The resulting data.frame contains the ID and rating along the 768
embedding dimensions:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reviews_embeddings</span></span>
<span><span class="co">#&gt; # A tibble: 500 × 770</span></span>
<span><span class="co">#&gt;       id rating   dim_1 dim_2 dim_3   dim_4  dim_5   dim_6   dim_7  dim_8   dim_9  dim_10 dim_11</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;fct&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     0 &lt;5      1.12   1.56  -4.48 -0.129  -0.373  0.390  -1.24    0.821 -0.0431 -0.261  -0.431</span></span>
<span><span class="co">#&gt;  2     1 5       0.792  0.721 -3.14 -0.808  -1.81   1.35    0.403  -0.377  0.358  -0.173  -0.643</span></span>
<span><span class="co">#&gt;  3     2 &lt;5      0.539  1.12  -2.58 -0.417  -0.992  1.77    0.895   0.174  0.199  -0.359  -0.637</span></span>
<span><span class="co">#&gt;  4     3 5      -0.150  1.25  -4.12 -0.0750 -0.835  1.06   -0.0965 -0.292  0.636  -1.20   -0.188</span></span>
<span><span class="co">#&gt;  5     4 5       0.352  0.972 -3.40 -1.18   -0.686  0.489   0.127   0.473  0.259  -0.953  -0.757</span></span>
<span><span class="co">#&gt;  6     5 &lt;5      0.907  0.975 -2.78 -0.638  -1.48   2.21    0.373  -0.448  0.395  -0.371  -0.442</span></span>
<span><span class="co">#&gt;  7     6 5       0.523  0.321 -2.46 -0.678  -0.640  0.501   0.703   0.320  0.442   0.500  -0.814</span></span>
<span><span class="co">#&gt;  8     7 &lt;5      0.224  0.694 -3.12 -0.562  -1.50  -0.0708  0.178   0.144  0.367   0.0269 -0.755</span></span>
<span><span class="co">#&gt;  9     8 5      -0.0477 1.21  -3.70 -0.300  -0.936  0.583   0.135  -0.234  0.220  -0.384   0.512</span></span>
<span><span class="co">#&gt; 10     9 5      -0.105  1.13  -3.22 -0.310  -1.69   0.857  -0.157  -0.122  0.227  -0.513  -0.333</span></span>
<span><span class="co">#&gt; # ℹ 490 more rows</span></span>
<span><span class="co">#&gt; # ℹ 757 more variables: dim_12 &lt;dbl&gt;, dim_13 &lt;dbl&gt;, dim_14 &lt;dbl&gt;, dim_15 &lt;dbl&gt;, dim_16 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_17 &lt;dbl&gt;, dim_18 &lt;dbl&gt;, dim_19 &lt;dbl&gt;, dim_20 &lt;dbl&gt;, dim_21 &lt;dbl&gt;, dim_22 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_23 &lt;dbl&gt;, dim_24 &lt;dbl&gt;, dim_25 &lt;dbl&gt;, dim_26 &lt;dbl&gt;, dim_27 &lt;dbl&gt;, dim_28 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_29 &lt;dbl&gt;, dim_30 &lt;dbl&gt;, dim_31 &lt;dbl&gt;, dim_32 &lt;dbl&gt;, dim_33 &lt;dbl&gt;, dim_34 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_35 &lt;dbl&gt;, dim_36 &lt;dbl&gt;, dim_37 &lt;dbl&gt;, dim_38 &lt;dbl&gt;, dim_39 &lt;dbl&gt;, dim_40 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   dim_41 &lt;dbl&gt;, dim_42 &lt;dbl&gt;, dim_43 &lt;dbl&gt;, dim_44 &lt;dbl&gt;, dim_45 &lt;dbl&gt;, dim_46 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>As said above, these embeddings are often used in supervised machine
learning. I use part of <a href="https://emilhvitfeldt.com/post/textrecipes-series-pretrained-word-embeddings/" class="external-link">a
blog post by Emil Hvitfeldt</a> show how this can be done using the data
we embedded above in the powerful <code>tidymodels</code> collection of
packages:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co"># split data into training an test set (for validation)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">reviews_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">reviews_embeddings</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reviews_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">reviews_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up the model we want to use</span></span>
<span><span class="va">lasso_spec</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we specify that we want to do some hyperparameter tuning and bootstrapping</span></span>
<span><span class="va">param_grid</span> <span class="op">&lt;-</span> <span class="fu">grid_regular</span><span class="op">(</span><span class="fu">penalty</span><span class="op">(</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">reviews_boot</span> <span class="op">&lt;-</span> <span class="fu">bootstraps</span><span class="op">(</span><span class="va">reviews_train</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and we define the model. Here we use the embeddings to predict the rating</span></span>
<span><span class="va">rec_spec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">rating</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="fu">select</span><span class="op">(</span><span class="va">reviews_train</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bringing this together in a workflow</span></span>
<span><span class="va">wf_fh</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">rec_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lasso_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we do the tuning</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">lasso_grid</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">wf_fh</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">reviews_boot</span>,</span>
<span>  grid <span class="op">=</span> <span class="va">param_grid</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select the best model</span></span>
<span><span class="va">wf_fh_final</span> <span class="op">&lt;-</span> <span class="va">wf_fh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">lasso_grid</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and train a new model + predict the classes for the test set</span></span>
<span><span class="va">final_res</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">wf_fh_final</span>, <span class="va">reviews_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we extract these predictions</span></span>
<span><span class="va">final_pred</span> <span class="op">&lt;-</span> <span class="va">final_res</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and evaluate them with a few standard metrics</span></span>
<span><span class="va">my_metrics</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span>, <span class="va">precision</span>, <span class="va">recall</span>, <span class="va">f_meas</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">my_metrics</span><span class="op">(</span><span class="va">final_pred</span>, truth <span class="op">=</span> <span class="va">rating</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;   .metric   .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy  binary         0.744</span></span>
<span><span class="co">#&gt; 2 precision binary         0.690</span></span>
<span><span class="co">#&gt; 3 recall    binary         0.831</span></span>
<span><span class="co">#&gt; 4 f_meas    binary         0.754</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># and the ROC curve</span></span>
<span><span class="va">final_pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">rating</span>, <span class="va">.pred_5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figures%2Fsmldemo-1.png" alt="plot of chunk smldemo"><div class="figcaption">plot of chunk smldemo</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johannes B. Gruber, Maximilian Weber.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
